version: "3.7"
services:
    mosquitto-hub:
        image: eclipse-mosquitto:2.0
        container_name: mosquitto-hub
        expose:
            - 1883
        env_file:
            - ./env/mosquitto-hub.env
        volumes:
            - ./conf/mosquitto-hub/mosquitto.conf:/mosquitto/config/mosquitto.conf
            - ./data/mosquitto-hub:/mosquitto/data
            - ./logs/mosquitto-hub:/mosquitto/log

    mosquitto-trust:
        image: eclipse-mosquitto:2.0
        container_name: mosquitto-trust
        depends_on:
            - mosquitto-hub
        env_file:
            - ./env/mosquitto-trust.env
        ports:
            - "2883:1883"
            - "2901:9001"
        volumes:
            - ./conf/mosquitto-trust/mosquitto.conf:/mosquitto/config/mosquitto.conf
            - ./data/mosquitto-trust:/mosquitto/data
            - ./logs/mosquitto-trust:/mosquitto/log

    mosquitto-public:
        image: eclipse-mosquitto:2.0
        container_name: mosquitto-public
        depends_on:
            - mosquitto-hub
        env_file:
            - ./env/mosquitto-public.env
        ports:
            - "1883:1883"
            - "9001:9001"
        volumes:
            - ./conf/mosquitto-public/mosquitto.conf:/mosquitto/config/mosquitto.conf
            - ./conf/mosquitto-public/acl_file:/mosquitto/config/acl_file
            - ./data/mosquitto-public:/mosquitto/data
            - ./logs/mosquitto-public:/mosquitto/log

    grafana:
        image: grafana/grafana
        env_file:
            - ./env/grafana.env
        environment:
            - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_password
        volumes:
            - ./data/grafana:/var/lib/grafana

    homeassistant:
        image: homeassistant/home-assistant
        depends_on:
            - mosquitto-trust
        env_file:
            - ./env/homeassistant.env
        ports:
            - "8123:8123"
        restart: always
        volumes:
            - ./data/home-assistant:/config
            - /etc/localtime:/etc/localtime:ro

    influxdb:
        image: influxdb
        env_file:
            - ./env/influxdb.env
        ports:
            - "8086:8086"
            - "8083:8083"
            - "2003:2003"
        volumes:
            - ./conf/influxdb/influxdb.conf:/etc/influxdb/influxdb.conf:ro
            - ./data/influxdb:/var/lib/influxdb

    nodered:
        image: tyisi/node-red-docker-bootstrap
        depends_on:
            - mosquitto-trust
        env_file:
            - ./env/nodered.env
        ports:
            - "1880:1880"
        volumes:
            - ./conf/nodered:/bootstrap/conf/
            - ./data/nodered:/data

    portainer:
        image: portainer/portainer
        env_file:
            - ./env/portainer.env
        ports:
            - "9000:9000"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ./data/portainer:/data

    nginx-proxy:
        image: jwilder/nginx-proxy
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - /var/run/docker.sock:/tmp/docker.sock:ro

    sergeant:
        image: vanhack/smartspace-sergeant
        depends_on:
            - mosquitto-trust
        env_file:
            - ./env/sergeant.env

    isvhsopen-monitor:
        image: tyisi/url-to-mqtt
        depends_on:
            - mosquitto-trust
        env_file:
            - ./env/isvhsopen-monitor.env

    laserbusy-monitor:
        image: tyisi/url-to-mqtt
        depends_on:
            - mosquitto-trust
        env_file:
            - ./env/laserbusy-monitor.env

    sip-monitor:
        image: tyisi/sip-to-mqtt
        depends_on:
            - mosquitto-trust
        env_file:
            - ./env/sip-monitor.env
        ports:
            - "5060:5060"

    spacebus:
        image: nginx
        depends_on:
            - mosquitto-public
        env_file:
            - ./env/spacebus.env
        volumes:
            - ./data/spacebus:/usr/share/nginx/html
            - ./conf/spacebus/config.js:/usr/share/nginx/html/js/config.js

secrets:
    grafana_admin_password:
        file: ./secrets/grafana-admin-password
